<script lang="ts">
	import { onMount } from 'svelte';
	import EmblaCarousel from 'embla-carousel';
	import Autoplay from 'embla-carousel-autoplay';
	import type { Architect } from '$lib/types';

	let architects: Architect[] = [];
	let loading = true;
	onMount(async () => {
		const res = await fetch('/api/queries/architectPTS');
		architects = await res.json();
		loading = false;
	});

	let carousels = {};
	let hoveredCarousel = null;

	onMount(() => {
		// Initialize carousels for each architect
		architects.forEach((architect) => {
			const emblaNode = document.querySelector(`[data-carousel="${architect.architectId}"]`);
			if (emblaNode) {
				const autoplay = Autoplay({
					delay: 3000,
					stopOnMouseEnter: true,
					stopOnInteraction: false
				});

				const embla = EmblaCarousel(
					emblaNode,
					{
						loop: true,
						align: 'center',
						skipSnaps: false,
						dragFree: false
					},
					[autoplay]
				);

				carousels[architect.architectId] = embla;
			}
		});

		// Cleanup function
		return () => {
			Object.values(carousels).forEach((carousel) => {
				if (carousel) carousel.destroy();
			});
		};
	});

	function goToPrevious(taskId) {
		if (carousels[taskId]) {
			carousels[taskId].scrollPrev();
		}
	}

	function goToNext(taskId) {
		if (carousels[taskId]) {
			carousels[taskId].scrollNext();
		}
	}

	function handleMouseEnter(taskId) {
		hoveredCarousel = taskId;
	}

	function handleMouseLeave() {
		hoveredCarousel = null;
	}
</script>

{#if loading}
	<p>Loadingâ€¦</p>
{:else}
	<div class="p-8 sm:p-4">
		<div
			class="architect-grid mx-auto grid max-w-full grid-cols-1 gap-8 sm:grid-cols-2 sm:gap-4 lg:grid-cols-3"
		>
			{#each architects as architect}
				<div class="architect-card rounded-xl border border-gray-200 bg-white p-6 shadow sm:p-4">
					<h2 class="architect-name mb-2 text-center text-xl font-semibold text-gray-800">
						{architect.firstName}
					</h2>

					<div
						class="relative h-[300px] sm:h-[250px]"
						on:mouseenter={() => handleMouseEnter(architect.architectId)}
						on:mouseleave={handleMouseLeave}
					>
						<div class="h-full overflow-hidden" data-carousel={architect.architectId}>
							<div class="flex h-full">
								{#each Object.values(architect.tasks) as task}
									<div class="w-full flex-none px-2">
										<div
											class="task-card flex h-full flex-col rounded-lg border border-gray-200 bg-gray-100 p-4"
										>
											<h3 class="task-name mb-2 text-base font-semibold text-gray-600">
												{task.taskName}
											</h3>
											<div class="subtask-list flex h-full flex-col gap-1 overflow-y-auto p-2">
												{#each task.subtasks as subtask}
													<div
														class="subtask-card flex-shrink-0 rounded-md border border-gray-300 bg-white p-2"
													>
														<span class="text-sm text-gray-600">{subtask.subtaskName}</span>
													</div>
												{/each}
											</div>
										</div>
									</div>
								{/each}
							</div>
						</div>

						{#if hoveredCarousel === architect.architectId}
							<button
								class="previous-button absolute top-1/2 -left-3 z-10 flex h-9 w-9 -translate-y-1/2 cursor-pointer items-center justify-center rounded-full border border-gray-200 bg-white/95 shadow backdrop-blur-sm transition-all duration-200 ease-in-out hover:scale-105 hover:shadow-lg active:scale-95"
								on:click={() => goToPrevious(architect.architectId)}
								aria-label="Previous slide"
							>
								<svg
									width="24"
									height="24"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									class="text-gray-600 hover:text-gray-800"
								>
									<path d="m15 18-6-6 6-6" />
								</svg>
							</button>
							<button
								class="next-button absolute top-1/2 -right-3 z-10 flex h-9 w-9 -translate-y-1/2 cursor-pointer items-center justify-center rounded-full border border-gray-200 bg-white/95 shadow backdrop-blur-sm transition-all duration-200 ease-in-out hover:scale-105 hover:shadow-lg active:scale-95"
								on:click={() => goToNext(architect.architectId)}
								aria-label="Next slide"
							>
								<svg
									width="24"
									height="24"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									class="text-gray-600 hover:text-gray-800"
								>
									<path d="m9 18 6-6-6-6" />
								</svg>
							</button>
						{/if}
					</div>
				</div>
			{/each}
		</div>
	</div>
{/if}
